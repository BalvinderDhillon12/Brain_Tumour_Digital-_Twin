import pandas as pd
import numpy as np
from sklearn.decomposition import PCA
from sklearn.preprocessing import StandardScaler


df = pd.read_csv('/content/drive/MyDrive/hackathon_output/RADIOMICS_SELECTED_CASES.csv')
pred_cols = [col for col in df.columns if col.startswith('PRED_')]
X = df[pred_cols]

# Drop any columns with NaNs if they exist 
X = X.dropna(axis=1, how='all') # Drop empty columns
X = X.fillna(X.mean()) # Fill remaining NaNs with mean

scaler = StandardScaler()
X_scaled = scaler.fit_transform(X)

# Run PCA for 95% variance
pca = PCA(n_components=0.95)
X_pca = pca.fit_transform(X_scaled)

pca_cols = [f'PC_{i+1}' for i in range(X_pca.shape[1])]
df_pca = pd.DataFrame(X_pca, columns=pca_cols)
df_pca['Case'] = df['Case']
df_pca.to_csv('RADIOMICS_PCA_DATA.csv', index=False)

# Get feature importance for each component
loadings = pca.components_
important_features = []
for i in range(len(pca_cols)):
    idx = np.abs(loadings[i]).argmax()
    important_features.append({
        'Principal_Component': pca_cols[i],
        'Representative_Feature': pred_cols[idx],
        'Explained_Variance_Ratio': pca.explained_variance_ratio_[i]
    })

df_features = pd.DataFrame(important_features)
df_features.to_csv('PCA_EXTRACTED_RADIOMIC_PHENOTYPES.csv', index=False)


print(f"Original feature count: {len(pred_cols)}")
print(f"Components needed for 95% variance: {len(pca_cols)}")
print(df_features.head(10))
